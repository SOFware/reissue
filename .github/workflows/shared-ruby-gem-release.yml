name: Shared Ruby Gem Release

on:
  workflow_call:
    inputs:
      git_user_email:
        description: 'Git user email for commits'
        required: false
        type: string
        default: 'github-actions[bot]@users.noreply.github.com'
      git_user_name:
        description: 'Git user name for commits'
        required: false
        type: string
        default: 'github-actions[bot]'
      dry_run:
        description: 'Test workflow without publishing to RubyGems'
        required: false
        type: boolean
        default: false
    outputs:
      version:
        description: 'The version that was released'
        value: ${{ jobs.release.outputs.version }}

jobs:
  release:
    name: Release gem to RubyGems.org
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.released }}

    permissions:
      id-token: write  # Required for Trusted Publishing
      contents: write
      pull-requests: write

    steps:
      - name: Setup Git
        run: |
          git config --global user.email "${{ inputs.git_user_email }}"
          git config --global user.name "${{ inputs.git_user_name }}"

      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Configure Bundler
        run: bundle config set frozen false

      - name: Record starting branch
        id: start
        run: |
          echo "=== Git state before finalize ==="
          echo "branch=$(git branch --show-current)" >> $GITHUB_OUTPUT
          git branch --show-current
          git log --oneline -3
          git status

      - name: Debug state after finalize
        if: always()
        run: |
          echo "=== Git state after finalize ==="
          git branch --show-current
          git branch -a
          git log --oneline -3
          git status
          ls -la pkg/ || echo "No pkg directory"

      - name: Check for branch change after finalize
        id: finalize_branch
        run: |
          current_branch=$(git branch --show-current)
          echo "branch=$current_branch" >> $GITHUB_OUTPUT
          if [ "${{ steps.start.outputs.branch }}" != "$current_branch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Get version being released
        id: version
        run: |
          version=$(ls pkg/*.gem | head -1 | sed 's/.*-\([0-9][^-]*\)\.gem/\1/')
          echo "released=$version" >> $GITHUB_OUTPUT

      - name: Release gem to RubyGems
        if: inputs.dry_run != true
        uses: rubygems/release-gem@v1

      - name: Dry run - skip RubyGems publish
        if: inputs.dry_run == true
        run: echo "Dry run - would publish version ${{ steps.version.outputs.released }} to RubyGems"

      - name: Check for branch change after release
        id: release_branch
        run: |
          current_branch=$(git branch --show-current)
          echo "branch=$current_branch" >> $GITHUB_OUTPUT
          if [ "${{ steps.finalize_branch.outputs.branch }}" != "$current_branch" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit any uncommitted changes and create branch
        if: steps.release_branch.outputs.changed == 'false'
        id: manual_branch
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            branch_name="post-release/$(date +%Y%m%d%H%M%S)"
            git checkout -b "$branch_name"
            git commit -m "Bump version for next release"
            echo "branch=$branch_name" >> $GITHUB_OUTPUT
            echo "created=true" >> $GITHUB_OUTPUT
          else
            echo "created=false" >> $GITHUB_OUTPUT
          fi

      - name: Push and create PR
        if: steps.release_branch.outputs.changed == 'true' || steps.manual_branch.outputs.created == 'true'
        run: |
          if [ "${{ steps.release_branch.outputs.changed }}" == "true" ]; then
            branch="${{ steps.release_branch.outputs.branch }}"
          else
            branch="${{ steps.manual_branch.outputs.branch }}"
          fi
          git push -u origin "$branch"
          gh pr create \
            --title "Bump version for next release" \
            --body "Post-release version bump created by reissue rake task." \
            --base ${{ github.event.repository.default_branch }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
